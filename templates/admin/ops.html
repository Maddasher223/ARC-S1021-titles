<!-- templates/admin/ops.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin • Ops</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#121417; --card:#1d2024; --alt:#0f1114; --border:#3e444c;
      --text:#c4c9d4; --muted:#8e9297; --bright:#fff;
      --primary:#c39a3f; --primary-hover:#af8b39; --ring:rgba(195,154,63,.25);
      --danger:#f04747; --success:#43b581; --shadow:0 10px 40px rgba(0,0,0,.5);
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:16px/1.55 'Inter',system-ui,sans-serif; padding:24px }
    .container{ max-width:1120px; margin:0 auto; display:grid; gap:18px }

    .header{ display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:12px }
    h1{ margin:0; font:700 1.8rem 'Cinzel',serif; color:var(--bright) }
    .nav a{ color:var(--primary); text-decoration:none; font-weight:700; margin-left:12px }
    .nav a:hover{ text-decoration:underline }

    .flash{ padding:12px 14px; border-radius:10px; border:1px solid var(--primary); background:rgba(195,154,63,.12); color:var(--primary); font-weight:700 }
    .flash.error{ border-color:var(--danger); background:rgba(240,71,71,.12); color:#fff }
    .flash.success{ border-color:var(--success); background:rgba(67,181,129,.12); color:#0e1a0f }

    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:18px }
    .wide{ display:grid; grid-template-columns:1fr; gap:18px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:18px; border-top:3px solid var(--primary); box-shadow:var(--shadow) }
    .card h2{ margin:0 0 .5rem; font:700 1.2rem 'Cinzel',serif; color:var(--bright) }
    .muted{ color:var(--muted) }
    .btn{ display:inline-block; padding:10px 14px; border-radius:10px; background:var(--primary); color:#0a0b0d; font-weight:800; text-decoration:none; margin-right:10px; font-family:'Cinzel',serif }
    .btn:hover{ background:var(--primary-hover) }
    .row{ display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:14px; margin-top:10px }
    label{ display:block; font-size:.9rem; font-weight:700; color:var(--muted); margin-bottom:6px }
    input, select, button{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:var(--alt); color:var(--bright)
    }
    input:focus, select:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 4px var(--ring) }
    button{ background:var(--primary); border:0; cursor:pointer; font-weight:800; font-family:'Cinzel',serif }
    button:hover{ background:var(--primary-hover) }

    table{ width:100%; border-collapse:collapse }
    th,td{ padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top }
    th{ color:var(--muted); font:700 .8rem 'Cinzel',serif; letter-spacing:.03em; text-transform:uppercase }
    code{ background:var(--alt); padding:3px 6px; border-radius:8px; border:1px solid var(--border) }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header / Nav -->
    <div class="header">
      <h1>Operations</h1>
      <div class="nav">
        <a href="{{ url_for('admin.dashboard') }}">Dashboard</a>
        <a href="{{ url_for('admin.titles_page') }}">Titles</a>
        <a href="{{ url_for('admin.reservations_page') }}">Reservations</a>
        <a href="{{ url_for('admin.servers_page') }}">Servers</a>
        <a href="{{ url_for('admin.logout') }}">Logout</a>
      </div>
    </div>

    <!-- Flashes -->
    {% for category, message in get_flashed_messages(with_categories=True) %}
      <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}

    <div class="grid">
      <!-- App health -->
      <div class="card">
        <h2>Health & Info</h2>
        <p class="muted">Quick links useful during operations.</p>
        <p>
          <a class="btn" href="{{ url_for('health') }}" target="_blank" rel="noopener">View /health</a>
          <a class="btn" href="{{ url_for('dashboard') }}">Public Dashboard</a>
        </p>
        <p class="muted">
          If you hit any 5xx here, check logs and DB connectivity. The /health endpoint lists known server IDs.
        </p>
      </div>

      <!-- Live status -->
      <div class="card">
        <h2>Current Live Titles</h2>
        {% if active_titles %}
          <table>
            <thead>
              <tr>
                <th>Title</th>
                <th>Holder</th>
                <th>Expires</th>
              </tr>
            </thead>
            <tbody>
              {% for a in active_titles %}
                <tr>
                  <td><strong>{{ a.title }}</strong></td>
                  <td>{{ a.holder }}</td>
                  <td>{{ a.expires }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted">No active titles at the moment.</p>
        {% endif %}
      </div>
    </div>

    <!-- Live Controls -->
    <div class="wide">
      <div class="card">
        <h2>Live Title Controls</h2>
        <p class="muted" style="margin-top:.25rem">
          Actions below write to <code>ActiveTitle</code>. Timed titles will auto-expire after <strong>{{ shift_hours }}</strong> hour(s).
        </p>

        <div class="row">
          <!-- Assign Guardian of Harmony (never expires) -->
          <form action="{{ url_for('admin.manual_assign') }}" method="POST" autocomplete="off" novalidate>
            <label>Assign <strong>Guardian of Harmony</strong> now</label>
            <input type="hidden" name="title" value="Guardian of Harmony" />
            <input type="hidden" name="goh_only" value="1" />
            <input type="text" name="ign" placeholder="In-Game Name" required />
            <div style="margin-top:8px"><button type="submit">Assign GOH</button></div>
          </form>

          <!-- Assign a timed title now (expires after shift) -->
          <form action="{{ url_for('admin.manual_assign') }}" method="POST" autocomplete="off" novalidate>
            <label>Assign a <strong>timed title</strong> now</label>
            <select name="title" required>
              <option value="" disabled selected>Select title…</option>
              {% for t in requestable_titles %}
                <option value="{{ t }}">{{ t }}</option>
              {% endfor %}
            </select>
            <input type="text" name="ign" placeholder="In-Game Name" required style="margin-top:8px" />
            <div style="margin-top:8px"><button type="submit">Assign Timed Title</button></div>
          </form>

          <!-- Force release live title -->
          <form action="{{ url_for('admin.force_release') }}" method="POST">
            <label>Force release a live title</label>
            <select name="title" required>
              <option value="" disabled selected>Select title…</option>
              <option value="Guardian of Harmony">Guardian of Harmony</option>
              {% for t in requestable_titles %}
                <option value="{{ t }}">{{ t }}</option>
              {% endfor %}
            </select>
            <div style="margin-top:8px"><button type="submit" style="background:var(--danger)">Force Release</button></div>
          </form>
        </div>
      </div>

      <!-- Reservation / schedule helpers -->
      <div class="card">
        <h2>Schedule a Future Slot</h2>
        <p class="muted" style="margin-top:.25rem">
          Creates or updates a row in <code>Reservation</code>. Allowed times are constrained to the current grid
          (every {{ shift_hours }}h): {% for s in slots %}<code>{{ s }}</code>{% if not loop.last %}, {% endif %}{% endfor %}.
        </p>

        <form action="{{ url_for('admin.manual_set_slot') }}" method="POST" autocomplete="off" novalidate>
          <div class="row">
            <div>
              <label>Title</label>
              <select name="title" required>
                <option value="" disabled selected>Select title…</option>
                {% for t in requestable_titles %}
                  <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label>IGN</label>
              <input type="text" name="ign" placeholder="In-Game Name" required />
            </div>
            <div>
              <label>Date (UTC)</label>
              <input type="date" name="date" value="{{ today }}" required />
            </div>
            <div>
              <label>Slot (UTC)</label>
              <select name="slot" required>
                {% for s in slots %}
                  <option value="{{ s }}">{{ s }} UTC</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div style="margin-top:10px"><button type="submit">Save Reservation</button></div>
        </form>
      </div>

      <!-- Pointers to management pages -->
      <div class="card">
        <h2>Management</h2>
        <ul>
          <li><a href="{{ url_for('admin.titles_page') }}">Manage Titles</a> — toggle requestable, rename, set icons.</li>
          <li><a href="{{ url_for('admin.reservations_page') }}">Reservations</a> — search and export CSV.</li>
          <li><a href="{{ url_for('admin.servers_page') }}">Servers</a> — add/edit webhooks, guardian role IDs, default guild.</li>
        </ul>
        <p class="muted">This page now includes the force-assign / release controls you requested.</p>
      </div>
    </div>
  </div>
</body>
</html>