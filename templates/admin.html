<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <style>
    :root {
      --bg: #2f3136; --bg-dark: #202225; --text: #dcddde;
      --primary: #7289da; --border: #40444b;
      --danger: #f04747; --success: #43b581;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background-color: var(--bg-dark); color: var(--text);
      margin: 0; padding: 1em;
    }
    .container { max-width: 1200px; margin: auto; }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 1em;
    }
    h1, h2 { color: #fff; margin: 0; }
    h2 { margin-bottom: 0.5em; font-size: 1.2em; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    .cards-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 20px; }
    .card { background-color: var(--bg); border-radius: 8px; padding: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid var(--border); padding: 10px; text-align: left; }
    th { background-color: var(--bg-dark); }
    .form-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .form-row { display: flex; gap: 10px; }
    .form-row > * { flex: 1; }
    input, select, button {
      width: 100%; padding: 12px; border-radius: 5px; border: 1px solid var(--border);
      background-color: var(--bg-dark); color: var(--text); box-sizing: border-box; font-size: 14px;
    }
    button { cursor: pointer; font-weight: bold; border: none; }
    .btn-primary { background-color: var(--primary); }
    .btn-danger { background-color: var(--danger); }
    .btn-inline { padding: 8px 12px; font-size: 12px; }
    .flash-msg { padding: 12px; background-color: var(--success); color: white; border-radius: 8px; margin: 1em 0; }
    .nav-links a { color: var(--primary); text-decoration: none; }
    .nav-links a:hover { text-decoration: underline; }
    .schedule-wrap { overflow-x: auto; }
    .muted { opacity: 0.75; font-size: 13px; }
    .hr { border: 0; border-top: 1px solid var(--border); margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Admin Control Panel</h1>
      <div class="nav-links">
        <a href="{{ url_for('dashboard') }}">← Back to Dashboard</a> &middot;
        <a href="{{ url_for('admin_logout') }}">Logout</a>
      </div>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-msg">{{ messages[0] }}</div>
      {% endif %}
    {% endwith %}

    <div class="grid">

      <!-- Top controls: Set Shift Hours -->
      <div class="cards-2">
        <div class="card">
          <h2>Set Shift Hours</h2>
          <p class="muted">Current: <strong>{{ shift_hours or 12 }}</strong> hour(s). Affects future assignments and auto-activations.</p>
          <form action="{{ url_for('admin_set_shift_hours') }}" method="POST" class="form-grid" novalidate>
            <div class="form-row">
              <input type="number" name="hours" min="1" max="48" step="1" placeholder="e.g. 12" required />
              <button type="submit" class="btn-primary">Update</button>
            </div>
          </form>
        </div>

        <div class="card">
          <h2>Manual Assignment (Immediate)</h2>
          <p class="muted">Assign a title now. <em>Guardian of Harmony</em> won’t expire.</p>
          <form action="{{ url_for('admin_manual_assign') }}" method="POST" class="form-grid" novalidate>
            <select name="title" required>
              <option value="" disabled selected>Select Title</option>
              {% for t in all_titles %}
                <option value="{{ t }}">{{ t }}</option>
              {% endfor %}
            </select>
            <input type="text" name="ign" placeholder="In-Game Name" required />
            <button type="submit" class="btn-primary">Assign Now</button>
          </form>
        </div>
      </div>

      <!-- Active Titles -->
      <div class="card">
        <h2>Active Titles</h2>
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Holder</th>
              <th>Expires (UTC)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for t in active_titles %}
              <tr>
                <td>{{ t.title }}</td>
                <td>{{ t.holder }}</td>
                <td>{{ t.expires }}</td>
                <td>
                  <form action="{{ url_for('admin_force_release') }}" method="POST" style="margin:0;">
                    <input type="hidden" name="title" value="{{ t.title }}" />
                    <button type="submit" class="btn-danger btn-inline">Release</button>
                  </form>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="4" style="text-align:center;" class="muted">No active titles.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Upcoming Reservations (14 days) -->
      <div class="card">
        <h2>Upcoming Reservations (Next 14 Days)</h2>
        <p class="muted">Visualizing reserved slots. Shift length is <strong>{{ shift_hours or 12 }}</strong> hour(s).</p>
        <div class="schedule-wrap">
          <table>
            <thead>
              <tr>
                <th>Date \ Time</th>
                {% for s in slots %}
                  <th>{{ s }} UTC</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for d in days %}
                {% set dkey = d.isoformat() %}
                <tr>
                  <td><strong>{{ dkey }}</strong></td>
                  {% for s in slots %}
                    <td style="vertical-align: top;">
                      {% set day_slot = (schedule_lookup.get(dkey, {}) or {}).get(s, {}) %}
                      {% if day_slot %}
                        <ul style="margin:0; padding-left: 18px;">
                          {% for title, entry in day_slot.items() %}
                            {% set ign = entry.ign if entry is mapping and entry.ign is defined else (entry.get('ign') if entry is mapping else entry) %}
                            {% set coords = entry.coords if entry is mapping and entry.coords is defined else (entry.get('coords') if entry is mapping else None) %}
                            <li>
                              <strong>{{ title }}</strong>: {{ ign }}
                              {% if coords %}<span class="muted">({{ coords }})</span>{% endif %}
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <em class="muted">—</em>
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Force Set Specific Slot -->
      <div class="card">
        <h2>Force Set for a Slot</h2>
        <p class="muted">
          Overwrite current holder for a specific slot.
          <em>Guardian of Harmony</em> cannot be assigned to a timed slot.
        </p>
        <form action="{{ url_for('admin_manual_set_slot') }}" method="POST" class="form-grid" novalidate>
          <select name="title" required>
            <option value="" disabled selected>Select Title</option>
            {% for t in requestable_titles %}
              <option value="{{ t }}">{{ t }}</option>
            {% endfor %}
          </select>
          <input type="text" name="ign" placeholder="In-Game Name" required />
          <div class="form-row">
            <input type="date" name="date" value="{{ today }}" required />
            <select name="slot" required>
              {% for s in slots %}
                <option value="{{ s }}">{{ s }} UTC Slot</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn-primary">Force Set Slot</button>
        </form>
      </div>

    </div>
  </div>
</body>
</html>