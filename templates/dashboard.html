<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Server 1021 Temple Title Request Dashboard</title>

  <!-- Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- Theme --- */
    :root {
      --parchment-dark: #181a1f;
      --parchment-light: #181a1f;
      --ink-text: #e2e0dd;
      --ink-muted: #a19a92;
      --ink-bright: #ffffff;
      --brush-stroke-border: #5a524c;
      --shadow: 0 6px 20px rgba(0,0,0,0.35);

      --fire-nation-red: #d04033;
      --water-tribe-blue: #5d8e9c;
      --earth-kingdom-green: #688a4c;
      --air-nomad-grey: #a0a09e;
      --harmony-gold: #c39a3f;
      --generic-gold: #e8b351;

      --focus-gold: #e8b351;
      --button-gold: #e8b351;
      --button-gold-hover: #d4a24a;
    }

    html, body { height: 100%; }
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background-color: var(--parchment-dark);
      background-image:
        radial-gradient(circle at top left, rgba(245,241,232,0.05), transparent 40%),
        radial-gradient(circle at bottom right, rgba(245,241,232,0.05), transparent 50%);
      color: var(--ink-text);
      margin: 0; padding: 2rem; line-height: 1.6;
    }
    .container { max-width: 1600px; margin: 0 auto; display: grid; gap: 2rem; }

    h1, h2 { font-family: 'Cinzel', serif; color: var(--ink-bright); margin: 0; font-weight: 600; }
    h1 { display: flex; align-items: center; gap: 12px; font-size: 1.85rem; }
    h2 { display: flex; justify-content: space-between; align-items: center; font-size: 1.35rem; border-bottom: 2px solid var(--brush-stroke-border); padding-bottom: .65rem; letter-spacing: .4px; }
    h3 { color: var(--ink-bright); margin: 0; font-weight: 600; font-size: 1.05rem; }

    a { color: var(--focus-gold); text-decoration: none; font-weight: 600; }
    a:hover { text-decoration: underline; }

    /* Cards */
    .card {
      background: var(--parchment-light);
      border: 1px solid var(--brush-stroke-border);
      border-radius: 10px;
      padding: 22px;
      box-shadow: var(--shadow);
    }

    /* Flash messages */
    .flash-list { margin: 0; padding: 0; list-style: none; }
    .flash {
      padding: 12px 14px; border-radius: 8px; color: #1a1208; margin: .5rem 0; font-weight: 700;
      background: #d7c08a;
    }
    .flash.error { background: #b25555; color: #fff; }
    .flash.message, .flash.success { background: #cdb069; color: #1a1208; }

    /* Status grid */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 18px;
    }
    .title-card {
      background: var(--parchment-dark);
      border: 1px solid var(--brush-stroke-border);
      border-left: 5px solid;
      border-radius: 10px;
      padding: 16px;
      position: relative;
    }
    .title-card h3 { display: flex; align-items: center; gap: 10px; margin: 0 0 .5rem; }
    .title-card p { margin: .25rem 0 0; font-size: .95rem; color: var(--ink-muted); }
    .title-card p strong { color: var(--ink-text); font-weight: 700; }
    .title-effects {
      position: absolute; top: 0; right: 0; background: var(--parchment-dark);
      border-left: 1px solid var(--brush-stroke-border);
      border-bottom: 1px solid var(--brush-stroke-border);
      border-radius: 0 10px 0 10px; padding: 6px 10px; font-size: 0.8rem;
      color: var(--ink-muted); font-weight: 500; opacity: 0; visibility: hidden; transition: opacity 0.2s;
    }
    .title-card:hover .title-effects { opacity: 1; visibility: visible; }

    /* Element accents */
    .title-guardian-of-fire { border-left-color: var(--fire-nation-red); }
    .title-guardian-of-water { border-left-color: var(--water-tribe-blue); }
    .title-guardian-of-earth { border-left-color: var(--earth-kingdom-green); }
    .title-guardian-of-air { border-left-color: var(--air-nomad-grey); }
    .title-guardian-of-harmony { border-left-color: var(--harmony-gold); }
    .title-architect, .title-general, .title-governor, .title-prefect { border-left-color: var(--generic-gold); }

    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: 2fr 2fr 2fr 1.5fr 1.5fr 1fr;
      gap: 14px;
      align-items: end;
    }
    label { font-size: .9rem; font-weight: 600; color: var(--ink-muted); display: block; margin-bottom: 6px; }
    input, select, button {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--brush-stroke-border);
      background: var(--parchment-dark); color: var(--ink-text); box-sizing: border-box; font-size: 1rem;
      transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
    }
    input:focus, select:focus {
      outline: none; border-color: var(--focus-gold);
      box-shadow: 0 0 0 3px rgba(232, 179, 81, 0.25);
    }
    button {
      background: var(--button-gold); color: #2a2118; font-weight: 800; border: none; cursor: pointer;
      font-family: 'Cinzel', serif; font-size: 1.05rem;
      transition: background-color .15s ease, transform .06s ease;
    }
    button:hover { background: var(--button-gold-hover); }
    button:active { transform: scale(.985); }

    /* Upcoming reservations table */
    .table-wrap { background: var(--parchment-light); border: 1px solid var(--brush-stroke-border); border-radius: 10px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; padding: 12px 14px; background: #14181d; color: #aeb6c4; font-size: .85rem; letter-spacing: .04em; text-transform: uppercase; font-family: 'Cinzel', serif; }
    tbody td { padding: 12px 14px; border-top: 1px solid var(--brush-stroke-border); vertical-align: top; }
    .day-col { width: 160px; white-space: nowrap; font-weight: 700; color: var(--ink-bright); }
    .time-block { margin-bottom: 10px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#202631; color:#aeb6c4; font-size:.85rem; margin-right:8px; }
    .muted { color: var(--ink-muted); }
    .empty { padding: 18px; text-align:center; color: var(--ink-muted); }

    /* Filter row */
    .filter-row { display:flex; align-items:center; gap:12px; margin: 0 0 10px 0; }
    .filter-row label { margin:0; }
    .filter-row select { max-width: 320px; }

    /* Footer */
    .footer-links { text-align: center; font-size: .9rem; color: var(--ink-muted); }
    .footer-links p { margin: .75rem 0 0; }

    /* Responsive tweaks */
    @media (max-width: 1200px) {
      .form-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    }
    @media (max-width: 992px) {
      body { padding: 1.5rem; }
      h1 { font-size: 1.6rem; }
      h2 { font-size: 1.25rem; }
    }
    @media (max-width: 768px) {
      body { padding: 1rem; }
      .container { gap: 1.5rem; }
      .card { padding: 18px; }
      .status-grid { grid-template-columns: 1fr; }
      thead th, tbody td { padding: 10px 10px; }
      .filter-row { flex-direction: column; align-items: flex-start; }
      .filter-row select { width: 100%; max-width: none; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.35rem; gap: 10px; }
      input, select, button { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1>
        <img src="{{ url_for('static', filename='icons/title-requestor.png') }}" width="32" height="32" alt="App icon" />
        Server 1021 Temple Title Request Dashboard
      </h1>
    </header>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        <ul class="flash-list">
          {% for category, message in messages %}
            <li class="flash {{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- Title status cards -->
    <section class="card">
      <h2>Title Status</h2>
      <div class="status-grid">
        {% for title in titles %}
          {% set tclass = title.name|lower|replace(' ', '-') %}
          <div class="title-card title-{{ tclass }}">
            <h3>
              <img src="{{ title.icon }}" width="24" height="24" alt="">
              {{ title.name }}
            </h3>
            <p><strong>Holder:</strong> {{ title.holder }}</p>
            <p><strong>Expires:</strong> {{ title.expires_in }}</p>
            {% if title.held_for %}
              <p><strong>Held:</strong> {{ title.held_for }}</p>
            {% endif %}
            {% if title.buffs %}
              <div class="title-effects">Effects: {{ title.buffs }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </section>

    <!-- Reservation form -->
    <section class="card">
      <h2>Reserve a {{ shift_hours|default(12) }}-hour Slot</h2>
      <p style="color: var(--ink-muted); font-size: .95rem; margin-top:.25rem;">
        All times are in UTC. Reach the Guardian of Harmony if you have questions.
      </p>
      <form action="{{ url_for('book_slot') }}" method="POST" novalidate>
        <div class="form-grid">
          <div>
            <label for="title">Title</label>
            <select id="title" name="title" required>
              <option value="" disabled selected>Select a Title...</option>
              {% for t in requestable_titles %}
                <option value="{{ t }}">{{ t }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="ign">In-Game Name</label>
            <input id="ign" type="text" name="ign" placeholder="In-Game Name" required />
          </div>

          <div>
            <label for="coords">Coordinates (X:Y)</label>
            <input id="coords" type="text" name="coords" placeholder="123:456" pattern="^\\s*\\d+\\s*:\\s*\\d+\\s*$" required />
          </div>

          <div>
            <label for="date">Date (UTC)</label>
            <input id="date" type="date" name="date" value="{{ today }}" required />
          </div>

          <div>
            <label for="time">Time (UTC)</label>
            <select id="time" name="time" required>
              {% for hh in hours %}
                <option value="{{ hh }}">{{ hh }} UTC</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label>&nbsp;</label>
            <button type="submit">Reserve Slot</button>
          </div>
        </div>
      </form>
    </section>

    <!-- Time Guide -->
    <section class="card">
      <h2>Time Guide</h2>
      <p style="color: var(--ink-muted); font-size: .95rem; margin-top:.25rem;">
        Quick reference for common regions. All scheduling is in UTC.
      </p>
      <table class="timezone-table" id="tz-table">
        <thead>
          <tr>
            <th>Region</th>
            <th>Timezone</th>
            <th>00:00 UTC</th>
            <th>12:00 UTC</th>
          </tr>
        </thead>
        <tbody><!-- filled by JS --></tbody>
      </table>
    </section>

    <!-- Upcoming Reservations (with title filter) -->
    <section class="card">
      <h2>Upcoming Reservations (Next {{ days|length }} Days)</h2>

      <!-- filter dropdown -->
      <div class="filter-row">
        <label for="filter-title">Filter by title:</label>
        <select id="filter-title">
          <option value="">All titles</option>
          {% for t in titles %}
            <option value="{{ t.name }}">{{ t.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="table-wrap">
        <table id="upcoming-table">
          <thead>
            <tr>
              <th class="day-col">Date (UTC)</th>
              <th>Reservations</th>
            </tr>
          </thead>
          <tbody>
            {% set any_rows = false %}
            {% for d in days %}
              {% set dkey = d.isoformat() %}
              {% set times = schedule_lookup.get(dkey, {}) %}
              <tr class="day-row" data-day="{{ dkey }}">
                <td class="day-col">{{ dkey }}</td>
                <td>
                  {% if times %}
                    {% set any_rows = true %}
                    {% for hhmm, titles_at_time in times.items() %}
                      <div class="time-block">
                        <strong class="time-label">{{ hhmm }} UTC</strong>
                        <ul class="time-list" style="margin:.35rem 0 0 .9rem; padding:0;">
                          {% for title, entry in titles_at_time.items() %}
                            <li class="res-item"
                                data-title="{{ title }}"
                                style="list-style: none; margin: 6px 0;">
                              <span class="pill">{{ title }}</span>
                              {{ entry.get('ign') }}
                              {% if entry.get('coords') %}
                                <span class="muted">({{ entry.get('coords') }})</span>
                              {% endif %}
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endfor %}
                  {% else %}
                    <span class="muted no-resv">No reservations.</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
            {% if not any_rows %}
              <tr><td colspan="2" class="empty">No reservations in this window.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer-links">
      <a href="{{ url_for('view_log') }}">View Full Request Log</a> &middot;
      <a href="{{ url_for('admin_login') }}">Admin Dashboard</a>
      <p>This is an unofficial tool for the Server 1021 Avatar: Realms Collide community.</p>
    </footer>
  </div>

  <!-- Time Guide + Title Filter JS -->
  <script>
  (function() {
    // --- Time Guide (DST-aware) ---
    const ZONES = [
      { label: "Los Angeles (US PT)", tz: "America/Los_Angeles", abbr: "PT" },
      { label: "US Mountain",         tz: "America/Denver",      abbr: "MT" },
      { label: "US Central",          tz: "America/Chicago",     abbr: "CT" },
      { label: "New York (US ET)",    tz: "America/New_York",    abbr: "ET" },
      { label: "Mexico City",         tz: "America/Mexico_City", abbr: "CT (MX)" },
      { label: "United Kingdom",      tz: "Europe/London",       abbr: "UK" },
      { label: "Germany",             tz: "Europe/Berlin",       abbr: "DE" },
      { label: "Argentina",           tz: "America/Argentina/Buenos_Aires", abbr: "ART" }
    ];

    function utcDateAt(utcHours, utcMinutes) {
      const now = new Date();
      return new Date(Date.UTC(
        now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(),
        utcHours, utcMinutes, 0, 0
      ));
    }

    function formatLocal(dtUTC, targetTZ) {
      const dayUTC = new Intl.DateTimeFormat('en-GB', { timeZone: 'UTC', day: '2-digit' }).format(dtUTC);
      const parts = new Intl.DateTimeFormat('en-GB', {
        timeZone: targetTZ, hour: '2-digit', minute: '2-digit',
        day: '2-digit', month: '2-digit', year: 'numeric', hour12: false
      }).formatToParts(dtUTC);

      const hh = parts.find(p => p.type === 'hour')?.value ?? '00';
      const mm = parts.find(p => p.type === 'minute')?.value ?? '00';
      const dayLocal = parts.find(p => p.type === 'day')?.value;

      let badge = '';
      if (dayLocal && dayUTC) {
        const nDay = parseInt(dayLocal, 10), uDay = parseInt(dayUTC, 10);
        if (!isNaN(nDay) && !isNaN(uDay)) {
          if (nDay === uDay + 1 || (uDay >= 28 && nDay === 1)) badge = '<span class="tz-dayflag">Next day</span>';
          else if (nDay === uDay - 1 || (nDay >= 28 && uDay === 1)) badge = '<span class="tz-dayflag">Prev. day</span>';
        }
      }
      return `<strong>${hh}:${mm}</strong> ${badge}`;
    }

    function fillTimeGuide() {
      const tbody = document.querySelector('#tz-table tbody');
      if (!tbody) return;

      const midnightUTC = utcDateAt(0, 0);
      const noonUTC     = utcDateAt(12, 0);

      const rows = ZONES.map(z => {
        const t00 = formatLocal(midnightUTC, z.tz);
        const t12 = formatLocal(noonUTC,     z.tz);
        return `
          <tr>
            <td>${z.label}</td>
            <td>${z.abbr}</td>
            <td>${t00}</td>
            <td>${t12}</td>
          </tr>
        `;
      });

      tbody.innerHTML = rows.join('');
    }

    fillTimeGuide();

    // --- Title Filter (client-side) ---
    const select = document.getElementById('filter-title');
    const table  = document.getElementById('upcoming-table');

    function applyFilter() {
      const want = (select.value || '').trim();
      const dayRows = table.querySelectorAll('tbody tr.day-row');

      dayRows.forEach(row => {
        const timeBlocks = row.querySelectorAll('.time-block');
        let dayHasAny = false;

        timeBlocks.forEach(block => {
          const items = block.querySelectorAll('.res-item');
          let blockHasAny = false;

          items.forEach(li => {
            const t = li.getAttribute('data-title') || '';
            const show = !want || t === want;
            li.style.display = show ? '' : 'none';
            if (show) blockHasAny = true;
          });

          // hide the block header if it has no visible items
          block.style.display = blockHasAny ? '' : 'none';
          if (blockHasAny) dayHasAny = true;
        });

        // show "No reservations." placeholder if nothing visible in the day
        let placeholder = row.querySelector('.no-resv');
        if (!placeholder) {
          placeholder = document.createElement('span');
          placeholder.className = 'muted no-resv';
          placeholder.textContent = 'No reservations.';
          row.querySelector('td:nth-child(2)').appendChild(placeholder);
        }
        placeholder.style.display = dayHasAny ? 'none' : '';
      });
    }

    if (select) {
      select.addEventListener('change', applyFilter);
      // run once in case you want to pre-select via querystring later
      applyFilter();
    }
  })();
  </script>
</body>
</html>