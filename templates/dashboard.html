<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Server 1021 Temple Title Request Dashboard</title>

  <!-- Typography (keeps Inter for body; Cinzel only for headings vibe) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- Four-Nations-inspired palette, toned down --- */
    :root {
      --parchment-dark: #211e1c;        /* page bg */
      --parchment-light: #3a3532;       /* card bg */
      --ink-text: #e2e0dd;              /* body text */
      --ink-muted: #a19a92;             /* muted text */
      --ink-bright: #ffffff;            /* bright text */
      --brush-stroke-border: #5a524c;   /* borders */
      --shadow: 0 6px 20px rgba(0,0,0,0.35);

      /* Element tints (for borders/labels only) */
      --fire-nation-red: #d04033;
      --water-tribe-blue: #5d8e9c;
      --earth-kingdom-green: #688a4c;
      --air-nomad-grey: #a0a09e;
      --harmony-gold: #c39a3f;
      --generic-gold: #e8b351;

      /* Inputs & buttons */
      --focus-gold: #e8b351;
      --button-gold: #e8b351;
      --button-gold-hover: #d4a24a;
    }

    html, body { height: 100%; }
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background-color: var(--parchment-dark);
      background-image:
        radial-gradient(circle at top left, rgba(245,241,232,0.05), transparent 40%),
        radial-gradient(circle at bottom right, rgba(245,241,232,0.05), transparent 50%);
      color: var(--ink-text);
      margin: 0; padding: 2rem; line-height: 1.6;
    }
    .container { max-width: 1600px; margin: 0 auto; display: grid; gap: 2rem; }

    h1, h2 { font-family: 'Cinzel', serif; color: var(--ink-bright); margin: 0; font-weight: 600; }
    h1 { display: flex; align-items: center; gap: 12px; font-size: 1.85rem; }
    h2 { font-size: 1.35rem; border-bottom: 2px solid var(--brush-stroke-border); padding-bottom: .65rem; letter-spacing: .4px; }
    h3 { color: var(--ink-bright); margin: 0; font-weight: 600; font-size: 1.05rem; }

    a { color: var(--focus-gold); text-decoration: none; font-weight: 600; }
    a:hover { text-decoration: underline; }

    /* Cards */
    .card {
      background: var(--parchment-light);
      border: 1px solid var(--brush-stroke-border);
      border-radius: 10px;
      padding: 22px;
      box-shadow: var(--shadow);
    }

    /* Flash messages (keeps your categories working) */
    .flash-list { margin: 0; padding: 0; list-style: none; }
    .flash {
      padding: 12px 14px; border-radius: 8px; color: #1a1208; margin: .5rem 0; font-weight: 700;
      background: #d7c08a; /* neutral parchment banner for success/info */
    }
    .flash.error { background: #b25555; color: #fff; }
    .flash.message, .flash.success { background: #cdb069; color: #1a1208; }

    /* Status grid */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 18px;
    }
    .title-card {
      background: var(--parchment-dark);
      border: 1px solid var(--brush-stroke-border);
      border-left: 5px solid; /* colored accent */
      border-radius: 10px;
      padding: 16px;
      position: relative;
    }
    .title-card h3 { display: flex; align-items: center; gap: 10px; margin: 0 0 .5rem; }
    .title-card p { margin: .25rem 0 0; font-size: .95rem; color: var(--ink-muted); }
    .title-card p strong { color: var(--ink-text); font-weight: 700; }
    .title-effects {
      position: absolute; top: 0; right: 0; background: var(--parchment-dark);
      border-left: 1px solid var(--brush-stroke-border);
      border-bottom: 1px solid var(--brush-stroke-border);
      border-radius: 0 10px 0 10px; padding: 6px 10px; font-size: 0.8rem;
      color: var(--ink-muted); font-weight: 500; opacity: 0; visibility: hidden; transition: opacity 0.2s;
    }
    .title-card:hover .title-effects { opacity: 1; visibility: visible; }

    /* Element accent mapping (class derived from title name) */
    .title-guardian-of-fire { border-left-color: var(--fire-nation-red); }
    .title-guardian-of-water { border-left-color: var(--water-tribe-blue); }
    .title-guardian-of-earth { border-left-color: var(--earth-kingdom-green); }
    .title-guardian-of-air { border-left-color: var(--air-nomad-grey); }
    .title-guardian-of-harmony { border-left-color: var(--harmony-gold); }
    .title-architect, .title-general, .title-governor, .title-prefect { border-left-color: var(--generic-gold); }

    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: 2fr 2fr 2fr 1.5fr 1.5fr 1fr;
      gap: 14px;
      align-items: end;
    }
    label { font-size: .9rem; font-weight: 600; color: var(--ink-muted); display: block; margin-bottom: 6px; }
    input, select, button {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--brush-stroke-border);
      background: var(--parchment-dark); color: var(--ink-text); box-sizing: border-box; font-size: 1rem;
      transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
    }
    input:focus, select:focus {
      outline: none; border-color: var(--focus-gold);
      box-shadow: 0 0 0 3px rgba(232, 179, 81, 0.25);
    }
    button {
      background: var(--button-gold); color: #2a2118; font-weight: 800; border: none; cursor: pointer;
      font-family: 'Cinzel', serif; font-size: 1.05rem;
      transition: background-color .15s ease, transform .06s ease;
    }
    button:hover { background: var(--button-gold-hover); }
    button:active { transform: scale(.985); }

    /* Schedule */
    .schedule-grid-wrapper { overflow-x: auto; position: relative; }
    .schedule-grid-wrapper::after {
      content: ''; position: absolute; top: 0; right: 0; bottom: 0; width: 28px;
      background: linear-gradient(to right, transparent, var(--parchment-light)); pointer-events: none;
      opacity: 0; transition: opacity 0.3s;
    }
    @media (pointer: coarse) and (max-width: 992px) {
      .schedule-grid-wrapper::after { opacity: 1; }
    }

    table {
      width: 100%; min-width: 1200px; border-collapse: separate; border-spacing: 6px; table-layout: fixed;
      margin-top: .75rem;
    }
    thead th {
      color: var(--ink-muted);
      text-align: center; font-weight: 600; font-size: .9rem; padding: .5rem 0 .75rem;
      font-family: 'Cinzel', serif;
    }
    tbody th {
      position: sticky; left: 0; z-index: 1;
      background: var(--parchment-light);
      color: var(--ink-muted);
      font-weight: 700; font-family: 'Inter', system-ui, sans-serif;
      text-align: center;
    }
    td {
      background: var(--parchment-dark);
      border: 1px solid var(--brush-stroke-border);
      border-radius: 8px;
      padding: 8px;
      vertical-align: top;
      height: 104px;
      text-align: left;
    }
    .cell-booking {
      color: var(--ink-bright);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: .9rem;
      font-weight: 600;
      margin-bottom: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.45);
      overflow-wrap: break-word;
      word-break: normal;
    }
    .cell-booking strong { display: block; color: #fff; margin-bottom: 2px; font-weight: 800; }

    /* Booking color accents (class derived from title name) */
    .booking-guardian-of-fire { background: var(--fire-nation-red); }
    .booking-guardian-of-water { background: var(--water-tribe-blue); }
    .booking-guardian-of-earth { background: var(--earth-kingdom-green); }
    .booking-guardian-of-air { background: var(--air-nomad-grey); }
    .booking-guardian-of-harmony { background: var(--harmony-gold); }
    .booking-architect, .booking-general, .booking-governor, .booking-prefect { background: var(--generic-gold); color: #2a2118; }

    .booking-coords { opacity: .85; }

    /* Footer */
    .footer-links { text-align: center; font-size: .9rem; color: var(--ink-muted); }
    .footer-links p { margin: .75rem 0 0; }

    /* Responsive */
    @media (max-width: 1200px) {
      .form-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    }
    @media (max-width: 992px) {
      body { padding: 1.5rem; }
      h1 { font-size: 1.6rem; }
      h2 { font-size: 1.25rem; }
      .title-effects { display: none; }
    }
    @media (max-width: 768px) {
      body { padding: 1rem; }
      .container { gap: 1.5rem; }
      .card { padding: 18px; }
      .status-grid { grid-template-columns: 1fr; }
      table { min-width: 800px; border-spacing: 4px; }
      td { height: auto; min-height: 90px; }
      .cell-booking { font-size: .85rem; padding: 6px 8px; line-height: 1.4; }
      .booking-coords { display: block; font-size: .75rem; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.35rem; gap: 10px; }
      .booking-coords { display: none; }
      input, select, button { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header (keeps your original app icon src) -->
    <header>
      <h1>
        <img src="{{ url_for('static', filename='icons/title-requestor.png') }}" width="32" height="32" alt="App icon" />
        Title Dashboard
      </h1>
    </header>

    <!-- Flash messages (supports both plain and categorized flashes) -->
    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        <ul class="flash-list">
          {% for category, message in messages %}
            <li class="flash {{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- Title status cards -->
    <section class="card">
      <h2>Title Status</h2>
      <div class="status-grid">
        {% for title in titles %}
          {# derive a safe class from the title name, e.g., "Guardian of Fire" -> "guardian-of-fire" #}
          {% set tclass = title.name|lower|replace(' ', '-') %}
          <div class="title-card title-{{ tclass }}">
            <h3>
              <!-- keep original icon src from backend -->
              <img src="{{ title.icon }}" width="24" height="24" alt="">
              {{ title.name }}
            </h3>
            <p><strong>Holder:</strong> {{ title.holder }}</p>
            <p><strong>Expires:</strong> {{ title.expires_in }}</p>
            {% if title.held_for %}
              <p><strong>Held:</strong> {{ title.held_for }}</p>
            {% endif %}
            {% if title.buffs %}
              <div class="title-effects">Effects: {{ title.buffs }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </section>

    <!-- Reservation form (names/ids unchanged to keep backend working) -->
    <section class="card">
      <h2>Reserve a {{ shift_hours|default(12) }}-hour Slot</h2>
      <p style="color: var(--ink-muted); font-size: .95rem; margin-top:.25rem;">
        All times are in UTC. Reach the Guardian of Harmony if you have any questions.
      </p>
      <form action="{{ url_for('book_slot') }}" method="POST" novalidate>
        <div class="form-grid">
          <div>
            <label for="title">Title</label>
            <select id="title" name="title" required>
              <option value="" disabled selected>Select a Title...</option>
              {% for t in requestable_titles %}
                <option value="{{ t }}">{{ t }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="ign">In-Game Name</label>
            <input id="ign" type="text" name="ign" placeholder="In-Game Name" required />
          </div>

          <div>
            <label for="coords">Coordinates (X:Y)</label>
            <input id="coords" type="text" name="coords" placeholder="123:456" pattern="^\\s*\\d+\\s*:\\s*\\d+\\s*$" required />
          </div>

          <div>
            <label for="date">Date (UTC)</label>
            <input id="date" type="date" name="date" value="{{ today }}" required />
          </div>

          <div>
            <label for="time">Time (UTC)</label>
            <select id="time" name="time" required>
              <option value="00:00">00:00 UTC</option>
              <option value="12:00">12:00 UTC</option>
            </select>
          </div>

          <div>
            <label>&nbsp;</label>
            <button type="submit">Reserve Slot</button>
          </div>
        </div>
      </form>
    </section>

    <!-- Two-week schedule -->
    <section class="card">
      <h2>Two Week Schedule ({{ shift_hours|default(12) }}-Hour Slots)</h2>
      <div class="schedule-grid-wrapper">
        <table>
          <thead>
            <tr>
              <th style="text-align:center;">Time</th>
              {% for day in days %}
                <th style="text-align:center;">
                  {{ day.strftime('%a %d') }}<br>{{ day.strftime('%b') }}
                </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for hour in hours %}
              <tr>
                <th>{{ hour }} UTC</th>
                {% for day in days %}
                  <td>
                    {# Build the same slot key the backend writes: YYYY-MM-DDTHH:MM:SS #}
                    {% set slot_time = day.strftime('%Y-%m-%d') ~ 'T' ~ hour ~ ':00' %}
                    {% for title_name, schedule_data in schedules.items() %}
                      {% set reservation = schedule_data.get(slot_time) %}
                      {% if reservation %}
                        {% set bclass = title_name|lower|replace(' ', '-') %}
                        <div class="cell-booking booking-{{ bclass }}">
                          <strong>{{ title_name }}</strong>
                          {% if reservation is mapping %}
                            {{ reservation.get('ign') }}
                            {% if reservation.get('coords') %} <span class="booking-coords">({{ reservation.get('coords') }})</span>{% endif %}
                          {% else %}
                            {{ reservation }}
                          {% endif %}
                        </div>
                      {% endif %}
                    {% endfor %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer-links">
      <a href="{{ url_for('view_log') }}">View Full Request Log</a> &middot;
      <a href="{{ url_for('admin_login') }}">Admin Dashboard</a>
      <p>This is an unofficial tool for the Server 1021 Avatar: Realms Collide community.</p>
    </footer>
  </div>
</body>
</html>